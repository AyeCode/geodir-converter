!function(e,t){"use strict";t.ajax=function(n,i,r,o){o=void 0!==o?o:{},r=void 0!==r?r:{};const s=t.nonces.hasOwnProperty(n)?t.nonces[n]:"";return r instanceof FormData?(r.append("action",n),r.append("geodir_converter_nonce",s),o.processData=!1,o.contentType=!1):(r.action=n,r.geodir_converter_nonce=s),o=e.extend(o,{url:t.ajaxUrl,dataType:"json",data:r,success:function(e){const t=!0===e.success,n=e.data||{};i(t,n)}}),e.ajax(o)},t.ControlButton={inSuspended:!1,wasDisabled:!1,defaultText:"",actionText:"",ajaxAction:"",converter:null,init:function(e,t){return this.element=e,this.defaultText=t.defaultText,this.actionText=t.actionText,this.ajaxAction=t.ajaxAction,this.converter=t.converter,this.element.on("click",this.click.bind(this)),this},click:function(){if(this.inSuspended)return!1;this.doAction()},doAction:function(){},activate:function(){this.inSuspended=!0,this.element.prop("disabled",!0),this.element.text(this.actionText)},enable:function(){this.inSuspended=!1,this.element.prop("disabled",!1),this.element.text(this.defaultText)},disable:function(){this.inSuspended=!1,this.element.prop("disabled",!0),this.element.text(this.defaultText)},suspend:function(){this.inSuspended=!0,this.wasDisabled=!!this.element.prop("disabled"),this.element.prop("disabled",!0)},restore:function(){this.inSuspended=!1,this.element.prop("disabled",this.wasDisabled)}},t.ImportButton=e.extend({},t.ControlButton,{doAction:function(){const e=this,n=this.converter.importerId,i=this.converter.errorHandler,r=this.converter.settings.find("form"),o=this.converter.files,s=r.serializeObject(),a=r.find("#test_mode").is(":checked")?"yes":"no",d=new FormData;if(n){if(d.append("test_mode",a),d.append("importerId",n),d.append("settings",JSON.stringify(s)),o.length>0)for(let e=0;e<o.length;e++)d.append("files[]",o[e]);this.activate(),i.hide(),t.ajax(e.ajaxAction,(function(t,n){t?e.converter.start():(e.enable(),e.converter.stop(),i.show(n.message))}),d,{method:"POST",contentType:!1,processData:!1})}}}),t.ConfigureButton=e.extend({},t.ControlButton,{activate:function(){this.element.addClass("btn-translucent-success").removeClass("btn-outline-primary").text(this.actionText)},enable:function(){this.element.addClass("btn-outline-primary").removeClass("btn-translucent-success").text(this.defaultText)},doAction:function(){const n=e(".geodir-converter-wrapper"),i=this.converter.element,r=this.converter.settings;n.find(".card-header h6").text(t.i18n.importSource),n.find(".geodir-converter-importer").not(i).addClass("d-none"),e(".geodir-converter-settings").not(r).addClass("d-none"),this.element.addClass("d-none"),this.converter.backButton.element.removeClass("d-none"),i.addClass("border-bottom-0"),r.removeClass("d-none")}}),t.BackButton=e.extend({},t.ControlButton,{doAction:function(){const n=e(".geodir-converter-wrapper"),i=this.converter.element,r=this.converter.settings;this.element.addClass("d-none"),this.converter.configureButton.element.removeClass("d-none"),i.removeClass("border-bottom-0"),r.addClass("d-none"),n.find(".card-header h6").text(t.i18n.selectImport),n.find(".geodir-converter-importer").removeClass("d-none"),r.find("form").length&&(r.find("form")[0].reset(),this.converter.errorHandler.clear())}}),t.AbortButton=e.extend({},t.ControlButton,{doAction:function(){this.activate(),this.converter.stop();const e=this.converter.importerId,n=this;t.ajax(n.ajaxAction,(function(e,t){n.converter.start(),e||n.enable()}),{importerId:e},{method:"POST"})}}),t.LogsHandler=e.extend({},{shown:0,userInteracting:!1,interactionTimeout:null,init:function(e){var t=this;return this.element=e,this.element.scrollTop(this.element[0].scrollHeight),this.element.on("mouseenter",(function(){t.userInteracting=!0})),this.element.on("mouseleave",(function(){clearTimeout(t.interactionTimeout),t.interactionTimeout=setTimeout((function(){t.userInteracting=!1}),1e3)})),this.element.on("wheel scroll touchstart",(function(){t.userInteracting=!0,clearTimeout(t.interactionTimeout);var e=t.element[0],n=Math.abs(e.scrollHeight-e.clientHeight-e.scrollTop)<5;t.interactionTimeout=n?setTimeout((function(){t.userInteracting=!1}),500):setTimeout((function(){t.userInteracting=!1}),3e3)})),this},insertLogs:function(e){this.element.append(e),this.userInteracting||this.element.scrollTop(this.element[0].scrollHeight)},setShown:function(e){this.shown=e},clear:function(){this.shown=0,this.userInteracting=!1,clearTimeout(this.interactionTimeout),this.element.html("")}}),t.ErrorHandler={init:function(e){return this.element=e,this},show:function(e){this.element.html(e).removeClass("d-none")},hide:function(){this.element.html("").addClass("d-none")},clear:function(){this.hide()},isVisible:function(){return!this.element.hasClass("d-none")}},t.ProgressBar=e.extend({},{barEl:null,init:function(e){return this.element=e,this.barEl=this.element.find(".progress-bar"),this},updateProgress:function(e){this.element.removeClass("d-none"),this.barEl.css("width",e+"%").text(e+"%")}}),t.DropZone=e.extend({},{dropzone:null,input:null,btn:null,uploads:null,init:function(e,t){this.element=e,this.converter=t.converter,this.dropzone=this.element.find(".geodir-converter-drop-zone"),this.btn=this.element.find(".geodir-converter-files-btn"),this.input=this.element.find(".geodir-converter-files-input"),this.uploads=this.element.find(".geodir-converter-uploads");const n=this;return this.disableStep2Inputs(!0),this.btn.on("click",(function(){n.input.trigger("click")})),this.dropzone.on("dragover dragenter",(function(e){e.preventDefault(),e.stopPropagation(),n.dropzone.addClass("dragover")})),this.dropzone.on("dragleave dragend drop",(function(e){e.preventDefault(),e.stopPropagation(),n.dropzone.removeClass("dragover")})),this.dropzone.on("drop",(function(e){n.handleFiles(e.originalEvent.dataTransfer.files)})),this.input.on("change",(function(e){e.preventDefault(),n.handleFiles(this.files)})),this},handleFiles:function(e){const t=this;Array.from(e).forEach((function(e){e.name.toLowerCase().endsWith(".csv")?t.uploadFile(e):aui_toast("geodir_converter_error","error",`${e.name} is not a CSV file.`)}))},uploadFile:function(n){const i=this,r="upload-"+Date.now(),o=this.renderUploadItem(r,n.name),s=e.extend({},t.ProgressBar).init(o.find(".progress")),a=o.find(".geodir-converter-progress-status"),d=o.find(".geodir-converter-progress-icon"),l=this.element.find('[name="edirectory_modules[]"]'),c=new FormData;c.append("file",n),c.append("importerId","edirectory"),t.ajax(t.actions.upload,(function(t,r){if(s.barEl.removeClass("progress-bar-animated"),d.removeClass("fa-sync"),t){s.barEl.addClass("bg-success"),d.addClass("fa-check text-success"),a.text(r.message),i.converter.files.some((e=>e.name===n.name&&e.size===n.size&&e.lastModified===n.lastModified))||i.converter.files.push(n);const t=l.map((function(){return e(this).val()})).get();if(r.module_type&&!t.includes(r.module_type)){t.push(r.module_type),l.remove();const e=t.map((e=>`<input type="hidden" name="edirectory_modules[]" value="${e}">`)).join("");i.element.append(e)}i.disableStep2Inputs(!1)}else s.barEl.addClass("bg-danger"),d.addClass("fa-triangle-exclamation text-danger"),a.text(`Upload failed: ${r.message}`),i.disableStep2Inputs(!0)}),c,{method:"POST",xhr:function(){const e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",(function(e){if(e.lengthComputable){const t=Math.round(e.loaded/e.total*100);s.updateProgress(t)}}),!1),e},error:function(){s.barEl.removeClass("progress-bar-animated").addClass("bg-danger"),d.removeClass("fa-sync").addClass("fa-triangle-exclamation text-danger"),a.text("Server error during upload."),i.disableStep2Inputs(!0)}})},disableStep2Inputs:function(e){this.element.find(".geodir-converter-configure-wrapper").find("input, select, textarea, button").not('[name="edirectory_modules[]"]').prop("disabled",e)},renderUploadItem:function(n,i){const r=e(`\n                <div class="upload-item my-2" data-id="${n}">\n                    <div class="d-flex justify-content-between align-items-center">\n                        <span class="fw-bold text-truncate">${i}</span>\n                        <i class="fas fa-solid fa-sync text-muted ms-2 geodir-converter-progress-icon" aria-hidden="true"></i>\n                    </div>\n                    <div class="progress my-1 d-none" role="progressbar" aria-valuemin="0" aria-valuemax="100">\n                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>\n                    </div>\n                    <div class="geodir-converter-progress-status small text-muted mt-1">${t.i18n.uploading}</div>\n                </div>\n            `);return this.uploads.append(r),this.uploads.find(`[data-id="${n}"]`)}}),t.Converter={tickInterval:2e3,shortTickInterval:400,retriesCount:1,retriesLeft:0,inProgress:!1,updateTimeout:null,preventUpdates:!1,importerId:null,files:[],init:function(n,i){this.element=n,this.inProgress=i.inProgress,this.resetRetries(),this.importerId=this.element.data("importer"),this.settings=this.element.find(".geodir-converter-settings");let r=e.extend({},t.ProgressBar);this.progressBar=r.init(this.element.find(".geodir-converter-progress"));let o=e.extend({},t.LogsHandler);this.logsHandler=o.init(this.element.find(".geodir-converter-logs"));let s=e.extend({},t.ConfigureButton);this.configureButton=s.init(this.element.find(".geodir-converter-configure"),{defaultText:t.i18n.runConverter,actionText:t.i18n.importing,converter:this});let a=e.extend({},t.BackButton);this.backButton=a.init(this.element.find(".geodir-converter-back"),{converter:this});let d=e.extend({},t.ImportButton);this.importButton=d.init(this.element.find(".geodir-converter-import"),{defaultText:t.i18n.import,actionText:t.i18n.importing,ajaxAction:t.actions.import,converter:this});let l=e.extend({},t.AbortButton);this.abortButton=l.init(this.element.find(".geodir-converter-abort"),{defaultText:t.i18n.abort,actionText:t.i18n.aborting,ajaxAction:t.actions.abort,converter:this});let c=e.extend({},t.ErrorHandler);this.errorHandler=c.init(this.element.find(".geodir-converter-error"),{converter:this});let u=e.extend({},t.DropZone);return this.dropZone=u.init(this.element.find(".geodir-converter-connect-wrapper"),{converter:this}),this.inProgress&&this.start(),this},start:function(){this.preventUpdates=!1,this.logsHandler.clear(),this.updateTimeout=setTimeout(this.tick.bind(this),this.shortTickInterval)},stop:function(){clearTimeout(this.updateTimeout),this.preventUpdates=!0},resetRetries:function(){this.retriesLeft=this.retriesCount},tick:function(){const e=this;t.ajax(t.actions.progress,(function(t,n){e.preventUpdates||(t?(e.resetRetries(),n.inProgress?e.markInProgress():e.markStopped(),n.inProgress?e.configureButton.activate():e.configureButton.enable(),e.progressBar.updateProgress(n.progress),e.logsHandler.setShown(n.logsShown),e.logsHandler.insertLogs(n.logs),e.dropZone.btn&&e.dropZone.btn.prop("disabled",n.inProgress),e.inProgress?e.updateTimeout=setTimeout(e.tick.bind(e),e.tickInterval):(e.abortButton.disable(),e.importButton.enable())):e.retriesLeft>0?(e.retriesLeft--,e.updateTimeout=setTimeout(e.tick.bind(e),e.tickInterval)):e.abortButton.disable())}),{logsShown:e.logsHandler.shown,importerId:this.importerId})},markInProgress:function(){this.inProgress=!0,this.importButton.activate(),this.abortButton.enable()},markStopped:function(){this.inProgress=!1,this.importButton.enable(),this.abortButton.disable()}},e((function(){e(".geodir-converter-importer").each((function(){e.extend({},t.Converter).init(e(this),{inProgress:Boolean(e(this).data("progress"))})}))})),e.fn.serializeObject=function(){var t={},n=this.serializeArray();return e.each(n,(function(){var e=this.name.replace(/\[\]$/,"");t[e]?(Array.isArray(t[e])||(t[e]=[t[e]]),t[e].push(this.value||"")):t[e]=this.value||""})),t}}(jQuery,GeoDir_Converter);